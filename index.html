<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>External Work Creation</title>
  <style>
    :root { --primary-color:#63AB8F; --primary-hover:#4D8F77; --border-color:#e0e0e0; --shadow:0 2px 8px rgba(0,0,0,.1); }
    body{font-family:'Aptos','Segoe UI',system-ui,-apple-system,sans-serif;background:#f9f9f9;margin:0;padding:2rem;max-width:650px;margin-inline:auto;color:#333;line-height:1.6}
    .card{background:#fff;border-radius:8px;box-shadow:var(--shadow);padding:2rem;margin-top:2rem}
    .logo-container{text-align:center;margin-bottom:1.5rem}
    #logo{max-width:180px;height:auto;margin-bottom:1rem}
    h1{color:var(--primary-color);font-weight:600;margin-bottom:1.5rem;font-size:1.8rem;text-align:center}
    label{display:block;margin:1.2rem 0 .4rem;font-weight:500;color:#555}
    select,input{width:100%;padding:.8rem;border:1px solid var(--border-color);border-radius:4px;font:inherit;transition:border .2s}
    select:focus,input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 2px rgba(99,171,143,.2)}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    button{width:100%;background:var(--primary-color);color:#fff;border:none;padding:.9rem;font-size:1rem;font-weight:500;border-radius:4px;cursor:pointer;transition:background .2s;margin-top:2rem;text-transform:uppercase;letter-spacing:.5px}
    button:hover{background:var(--primary-hover)}
    button:disabled{opacity:.6;cursor:not-allowed}
    #statusMessage{margin-top:1.5rem;padding:1rem;border-radius:4px;background:#f5f5f5;display:none}
    .success{color:#2e7d32;border-left:4px solid #4caf50;padding-left:1rem}
    .error{color:#c62828;border-left:4px solid #f44336;padding-left:1rem}
    .loader{display:none;text-align:center;margin:1rem 0}
    .spinner{border:3px solid rgba(0,0,0,.1);border-top:3px solid var(--primary-color);border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    small.hint{color:#666;display:block;margin-top:.25rem}
  </style>
</head>
<body>
  <div class="card">
    <div class="logo-container">
      <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
    </div>
    <h1>External Work Creation</h1>

    <label for="agentSelect">Select Agent</label>
    <select id="agentSelect" disabled>
      <option>Loading agentsâ€¦</option>
    </select>
    <small class="hint">Only whitelisted users appear here.</small>

    <label for="queueName">Queue</label>
    <input id="queueName" type="text" disabled />

    <div class="row">
      <button id="createBtn" disabled>Create</button>
    </div>

    <div class="loader" id="loader"><span class="spinner"></span> Processingâ€¦</div>
    <div id="statusMessage"></div>
  </div>

  <!-- 1) Load the Genesys Cloud SDK first -->
  <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>

  <!-- 2) Your app logic second -->
  <script>
    // --- Tiny UI helpers ---
    function showStatus(msg, isError=false){
      const box = document.getElementById("statusMessage");
      box.style.display = msg ? "block" : "none";
      box.textContent = msg || "";
      box.className = isError ? "error" : "success";
    }
    function showLoader(show){ document.getElementById("loader").style.display = show ? "block" : "none"; }

    (async function start(){
      // Ensure SDK is available
      if (!window.platformClient) {
        showStatus('Could not load Genesys Cloud SDK. Check network/CSP.', true);
        return;
      }

      // ===== CONFIG (your values) =====
      const CLIENT_ID    = "f2a0fa16-33cb-480b-a4ef-4766812dfb81";
      const REDIRECT_URI = "https://gmcglynn88.github.io/OVO_ExternalContact/";
      const ENVIRONMENT  = "euw2.pure.cloud";   // London (EUW2)

      // Whitelisted users (names will be fetched)
      const ALLOWED_USER_IDS = [
        "fa677b42-4aff-45af-b7e7-749418788b88",
        "206a7f52-4f89-446f-afbf-ac879147a7ad",
        "14ecd5fc-30f9-4214-809f-93771752bfb6",
        "79148e85-0da8-4f3e-9cdf-1ce4d832f5a4",
        "4ec6fd9a-e335-4d96-9504-05a1fbaa46a9",
        "207b29f5-8895-429c-b3bb-4879b41d8718",
        "4cd8cbf4-a8a1-4b49-9769-825d1cfc9e08",
        "6e917925-2cff-49b5-a730-55db79445280",
        "fed76596-cfa5-4fda-bb15-49985065480e",
        "660c4154-ba9b-4e84-90ec-c9c9b409ac41"
      ];

      // Single required queue (show friendly name)
      const REQUIRED_QUEUE_ID = "4a6f26c7-2b69-4c34-99e2-e156230ec2bd";

      // ===== INIT SDK =====
      const client = platformClient.ApiClient.instance;
      client.setEnvironment(ENVIRONMENT);

      const usersApi         = new platformClient.UsersApi();
      const routingApi       = new platformClient.RoutingApi();
      const conversationsApi = new platformClient.ConversationsApi(); // used by your existing flow

      // ===== Login =====
      try {
        await client.loginImplicitGrant(CLIENT_ID, REDIRECT_URI);
      } catch (e) {
        console.error(e);
        showStatus("Login failed. Double-check OAuth settings.", true);
        return;
      }

      // ===== Bootstrap UI (agents + queue) =====
      await loadAgents();
      await loadQueue();
      document.getElementById("createBtn").disabled = false;

      // ===== Wire Create (fire-and-forget, like your original) =====
      document.getElementById("createBtn").addEventListener("click", () => {
        const agentId = document.getElementById("agentSelect").value;
        if (!agentId) { showStatus("Please select an agent", true); return; }

        showLoader(true);
        showStatus("", false); // clear

        // Fire-and-forget: don't block the UI on completion/acceptance
        createExternalWork(agentId)
          .then(() => showStatus("External work created and auto-closed.", false))
          .catch(err => {
            console.error(err);
            showStatus("Failed to create external work.", true);
          })
          .finally(() => showLoader(false));
      });

      // ===== Helpers =====
      async function loadAgents(){
        const select = document.getElementById("agentSelect");
        select.innerHTML = '<option>Loadingâ€¦</option>';
        try{
          const results = await Promise.allSettled(ALLOWED_USER_IDS.map(id => usersApi.getUser(id)));
          const users = results
            .filter(r => r.status === "fulfilled" && r.value && !r.value.deleted)
            .map(r => r.value)
            .sort((a,b)=> (a.name||"").localeCompare(b.name||""));
          if (!users.length){
            select.innerHTML = '<option disabled>No whitelisted users found</option>';
            return;
          }
          select.innerHTML = "";
          for (const u of users){
            const opt = document.createElement("option");
            opt.value = u.id;
            opt.textContent = u.name || u.id;
            select.appendChild(opt);
          }
          select.disabled = false;
        }catch(err){
          console.error(err);
          select.innerHTML = '<option disabled>Failed to load agents</option>';
          showStatus("Failed to load agents.", true);
        }
      }

      async function loadQueue(){
        try{
          const q = await routingApi.getRoutingQueue(REQUIRED_QUEUE_ID);
          document.getElementById("queueName").value = q?.name || REQUIRED_QUEUE_ID;
        }catch(err){
          console.error(err);
          document.getElementById("queueName").value = "Queue not found";
        }
      }

      // ===== Your original behaviour (drop your working code here) =====
      async function createExternalWork(agentUserId){
        // ðŸ”»ðŸ”»ðŸ”» PASTE YOUR EXISTING CALLS IN THIS BLOCK ðŸ”»ðŸ”»ðŸ”»
        //
        // 1) Create the dummy email interaction that routes to REQUIRED_QUEUE_ID
        //    e.g. const convo = await conversationsApi.postConversationsEmails({ ... your payload ... });
        //
        // 2) Force-assign the participant to agentUserId
        //    e.g. await conversationsApi.patchConversationParticipant(convo.id, participantId, { userId: agentUserId });
        //
        // 3) Immediately disconnect / complete
        //    e.g. await conversationsApi.postConversationDisconnect(convo.id);
        //
        // NOTE: Keep exactly what worked in Dublin; only the region changed (to EUW2).
        // The UI will not wait for agent acceptance â€” it just kicks this off.

        // Temporary no-op so the button works while you paste your code:
        await new Promise(r => setTimeout(r, 300));
        return true;
        // ðŸ”ºðŸ”ºðŸ”º END PASTE AREA ðŸ”ºðŸ”ºðŸ”º
      }
    })();
  </script>
</body>
</html>
