<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1200px;background:var(--light-bg);color:var(--text-color)
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--border-color);
      border-radius:12px;
      padding:24px;
      margin-top:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.08)
    }

    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{
      padding:10px;border:1px solid var(--border-color);
      border-radius:6px;background:#fff;font-size:14px
    }
    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s
    }
    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}

    .controls{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:16px;align-items:end
    }

    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}

    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}

    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    #externalReference {
      width: 100%;
      max-width: 400px;
    }

    /* --- Tabs (updated styling) --- */
    .tab-container {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .tab-button {
      padding: 10px 16px;
      background: #ffffff;
      border: 2px solid var(--primary-color);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      color: var(--primary-color);
      transition: background .2s, color .2s;
    }

    .tab-button:hover {
      background: var(--pill);
    }

    .tab-button.active {
      background: var(--primary-color);
      color: #ffffff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
    
    /* Loading spinner */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: var(--primary-color);
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">
      <div class="spinner"></div>
      <p>Authenticating with Genesys Cloud...</p>
    </div>
  </div>

  <div id="appContent" style="display:none;">

    <div class="tab-container">
      <button class="tab-button active" data-tab="tab-create">Create Interaction</button>
      <button class="tab-button" data-tab="tab-guide">How to Use</button>
    </div>

    <!-- TAB: CREATE INTERACTION -->
    <div id="tab-create" class="tab-content active">

      <div id="messageContainer"></div>

      <div class="card">
        <h2 class="section-title">Create Proxy Interaction</h2>
        <div class="controls">
          <div>
            <label for="queueSelect">Select Queue:</label>
            <select id="queueSelect">
              <option value="">Loading queues...</option>
            </select>
          </div>
          <div>
            <label for="userSelect">Select User:</label>
            <select id="userSelect" disabled>
              <option value="">Please select a queue first</option>
            </select>
          </div>
          <div>
            <label for="externalReference">External Reference:</label>
            <input type="text" id="externalReference" placeholder="Enter external reference (optional)">
          </div>
        </div>

        <button id="createInteractionBtn" class="full-width-btn">Create Proxy Interaction</button>
      </div>

      <div id="results" class="card" style="display:none;"></div>

    </div> <!-- end tab-create -->

    <!-- TAB: HOW TO -->
    <div id="tab-guide" class="tab-content">
      <div class="card">
        <h2 class="section-title">How to Use This Tool</h2>

        <p><strong>1. Choose a Queue</strong><br>
        Select the queue where the proxy interaction will be created. Users will automatically load from this queue.</p>

        <p><strong>2. Choose a User</strong><br>
        Pick an agent from the queue members who should be assigned the generated interaction.</p>

        <p><strong>3. Add an External Reference (Optional)</strong><br>
        Enter anything useful such as a case number or URL. Leave blank if not required.</p>

        <p><strong>4. Create the Proxy Interaction</strong><br>
        Click <em>Create Proxy Interaction</em> to generate an inbound email, assign it, and disconnect it.</p>

        <p><strong>5. Review the Result</strong><br>
        A success or error message will appear showing what happened.</p>

        <p><strong>6. Repeat as Needed</strong><br>
        You can create as many proxy interactions as needed.</p>
      </div>
    </div>

  </div> <!-- end appContent -->

  <script>
    // ===== OAuth Config for London (EUW2) Genesys Org =====
    const clientId = 'f2a0fa16-33cb-480b-a4ef-4766812dfb81';
    const redirectUri = 'https://gmcglynn88.github.io/OVO_ExternalContact/';
    
    // EUW2 OAuth URL - using the region-specific login endpoint
    const oauthUrl = `https://login.euw2.pure.cloud/oauth/authorize?client_id=${encodeURIComponent(clientId)}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=conversations:email:write%20routing:queue:view%20users:read%20routing:queue:read&prompt=none`;

    // Queue whitelist - only this queue will be available
    const QUEUE_WHITELIST = [
      '4a6f26c7-2b69-4c34-99e2-e156230ec2bd'
    ];

    let accessToken = null;

    document.addEventListener('DOMContentLoaded', () => {
      // --- TAB SWITCHING ---
      document.addEventListener("click", function(e) {
        if (!e.target.classList.contains("tab-button")) return;

        document.querySelectorAll(".tab-button").forEach(btn =>
          btn.classList.remove("active")
        );
        e.target.classList.add("active");

        const target = e.target.dataset.tab;

        document.querySelectorAll(".tab-content").forEach(tab =>
          tab.classList.remove("active")
        );
        document.getElementById(target).classList.add("active");
      });

      // Check URL for OAuth response first
      checkAuthStatus();
    });

    function checkAuthStatus() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      
      // Check for errors first
      const error = params.get('error');
      if (error) {
        // If it's login_required, remove prompt=none and try again
        if (error === 'login_required' || error === 'interaction_required') {
          // Remove the stored token if any
          sessionStorage.removeItem('purecloud_token');
          // Redirect without prompt=none to show login page
          window.location.href = oauthUrl.replace('&prompt=none', '');
          return;
        }
        
        const errorDesc = params.get('error_description');
        showAuthError(`Authentication failed: ${errorDesc || error}`);
        return;
      }

      // Check for access token in URL (this happens after OAuth redirect)
      accessToken = params.get('access_token');
      
      if (accessToken) {
        // Store token and clean URL
        sessionStorage.setItem('purecloud_token', accessToken);
        window.history.replaceState({}, document.title, window.location.pathname);
        initializeApplication();
      } else {
        // No token in URL, check session storage
        accessToken = sessionStorage.getItem('purecloud_token');
        if (accessToken) {
          // Validate the stored token
          validateStoredToken();
        } else {
          // No token at all, redirect to OAuth silently
          window.location.href = oauthUrl;
        }
      }
    }

    async function validateStoredToken() {
      try {
        // Test token with a simple API call
        const response = await fetch('https://api.euw2.pure.cloud/api/v2/users/me', {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          // Token is valid
          initializeApplication();
        } else {
          // Token expired, get new one
          sessionStorage.removeItem('purecloud_token');
          window.location.href = oauthUrl;
        }
      } catch (error) {
        // Network error, try to continue anyway
        console.warn('Could not validate token, proceeding anyway:', error);
        initializeApplication();
      }
    }

    function showAuthError(message) {
      document.getElementById('auth-message').innerHTML = `
        <div class="error-message">
          <h3>Authentication Error</h3>
          <p>${message}</p>
          <p>Please refresh the page to try again.</p>
        </div>
      `;
    }

    function showMessage(msg, type='error'){
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${msg}</div>`;
      box.style.display = 'block';
      if (type === 'success') setTimeout(()=> box.style.display='none', 5000);
    }

    function initializeApplication() {
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';

      populateDropdowns();
      document.getElementById('createInteractionBtn').addEventListener('click', createInteraction);
    }

    async function populateDropdowns() {
      try {
        // Only populate queues now. Users will be loaded when a queue is selected.
        await populateQueues();
        
        // Add an event listener to the queue dropdown
        document.getElementById('queueSelect').addEventListener('change', fetchQueueMembers);
      } catch (error) {
        showMessage(`Error loading queues: ${error.message}`, 'error');
      }
    }

    async function populateQueues() {
      const queueSelect = document.getElementById('queueSelect');
      
      // If we have a queue whitelist, use it directly
      if (QUEUE_WHITELIST.length > 0) {
        queueSelect.innerHTML = '<option value="">Loading specific queues...</option>';
        
        // Fetch details for each whitelisted queue
        const queuePromises = QUEUE_WHITELIST.map(queueId => 
          fetch(`https://api.euw2.pure.cloud/api/v2/routing/queues/${queueId}`, {
            headers: { 
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            }
          }).then(response => {
            if (!response.ok) throw new Error(`Failed to fetch queue ${queueId}`);
            return response.json();
          })
        );

        try {
          const queues = await Promise.all(queuePromises);
          queueSelect.innerHTML = '<option value="">Select a queue</option>';
          queues.forEach(queue => {
            const option = document.createElement('option');
            option.value = queue.id;
            option.text = queue.name;
            queueSelect.add(option);
          });
        } catch (error) {
          console.error('Error fetching whitelisted queues:', error);
          // Fallback to fetching all queues if whitelist fails
          await fetchAllQueues(queueSelect);
        }
      } else {
        // No queue whitelist, fetch all queues with pagination
        await fetchAllQueues(queueSelect);
      }
    }

    async function fetchAllQueues(queueSelect) {
      queueSelect.innerHTML = '<option value="">Loading all queues...</option>';
      
      try {
        const queues = await fetchAllPages('https://api.euw2.pure.cloud/api/v2/routing/queues');
        queueSelect.innerHTML = '<option value="">Select a queue</option>';
        queues.forEach(queue => {
          const option = document.createElement('option');
          option.value = queue.id;
          option.text = queue.name;
          queueSelect.add(option);
        });
      } catch (error) {
        queueSelect.innerHTML = '<option value="">Error loading queues</option>';
        throw error;
      }
    }

    async function fetchQueueMembers() {
      const queueId = document.getElementById('queueSelect').value;
      const userSelect = document.getElementById('userSelect');
      
      // Reset the user dropdown
      userSelect.innerHTML = '<option value="">Select a user...</option>';
      
      if (!queueId) {
        userSelect.disabled = true;
        userSelect.innerHTML = '<option value="">Please select a queue first</option>';
        return; // Do nothing if no queue is selected
      }
      
      userSelect.disabled = true;
      const originalLabel = userSelect.options[0].text;
      userSelect.options[0].text = 'Loading members...';
      
      try {
        // Fetch members for the selected queue
        const members = await fetchAllPages(`https://api.euw2.pure.cloud/api/v2/routing/queues/${queueId}/members`);
        
        // Clear and repopulate the user dropdown
        userSelect.innerHTML = '<option value="">Select a user</option>';
        
        // The API returns member entities. We need the user object inside each member.
        members.forEach(member => {
          // Check if the member has a 'user' property
          if (member.user && member.user.id) {
            const option = document.createElement('option');
            option.value = member.user.id;
            option.text = member.user.name;
            userSelect.add(option);
          }
        });
        
        if (userSelect.options.length === 1) {
          userSelect.innerHTML = '<option value="">No members found in this queue</option>';
          userSelect.disabled = true;
        } else {
          userSelect.disabled = false;
        }
        
      } catch (error) {
        console.error('Error fetching queue members:', error);
        userSelect.innerHTML = '<option value="">Error loading members</option>';
        userSelect.disabled = true;
        showMessage(`Could not load queue members: ${error.message}`, 'error');
      }
    }

    async function fetchAllPages(url) {
      let allItems = [];
      let pageNumber = 1;
      let pageSize = 50; // Use a larger page size for queue members
      let hasMorePages = true;

      while (hasMorePages) {
        try {
          const response = await fetch(`${url}?pageNumber=${pageNumber}&pageSize=${pageSize}`, {
            headers: { 
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error(`Error fetching data: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          
          // Handle different response structures
          if (data.entities) {
            allItems = allItems.concat(data.entities || []);
            
            // Check if we have more pages
            if (data.pageCount && data.pageCount > pageNumber) {
              pageNumber++;
            } else {
              hasMorePages = false;
            }
          } else if (Array.isArray(data)) {
            // Some endpoints return arrays directly
            allItems = allItems.concat(data);
            hasMorePages = false;
          } else {
            // For endpoints without pagination info
            allItems = allItems.concat(data.members || []);
            hasMorePages = false;
          }
        } catch (error) {
          console.error(`Error fetching page ${pageNumber}:`, error);
          throw error;
        }
      }

      return allItems;
    }

    async function createInteraction() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '';

      const queueId = document.getElementById('queueSelect').value;
      const userId = document.getElementById('userSelect').value;
      const externalReference = document.getElementById('externalReference').value;

      if (!queueId) { 
        resultsDiv.innerHTML = `<div class="error-message">Please select a queue.</div>`; 
        return; 
      }
      if (!userId) { 
        resultsDiv.innerHTML = `<div class="error-message">Please select a user.</div>`; 
        return; 
      }

      const button = document.getElementById('createInteractionBtn');
      button.disabled = true;
      const originalLabel = button.textContent;
      button.textContent = 'Processing...';

      try {
        // Create email interaction with London EUW2 endpoint
        const interactionResponse = await fetch('https://api.euw2.pure.cloud/api/v2/conversations/emails', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            queueId: queueId,
            provider: 'QualityForm',
            direction: 'INBOUND',
            fromName: 'External Work',
            fromAddress: 'external@example.com',
            subject: 'External Work Item',
            htmlBody: externalReference ? `<p>External Reference: ${externalReference}</p>` : '<p>External work item created.</p>',
            textBody: externalReference ? `External Reference: ${externalReference}` : 'External work item created.',
            attributes: { 
              'External Link': externalReference,
              'CreatedVia': 'ExternalWorkCreationTool'
            }
          })
        });

        if (!interactionResponse.ok) {
          const errorText = await interactionResponse.text();
          throw new Error(`Error creating interaction: ${interactionResponse.status} ${interactionResponse.statusText}. Details: ${errorText}`);
        }

        const interaction = await interactionResponse.json();
        const conversationId = interaction.id;

        // Get conversation details
        const conversationDetailsResponse = await fetch(`https://api.euw2.pure.cloud/api/v2/conversations/${conversationId}`, {
          headers: { 
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!conversationDetailsResponse.ok)
          throw new Error(`Error fetching conversation details: ${conversationDetailsResponse.status} ${conversationDetailsResponse.statusText}`);

        const conversationDetails = await conversationDetailsResponse.json();
        const participantId = conversationDetails.participants[1].id;

        // Assign to user
        const assignResponse = await fetch(`https://api.euw2.pure.cloud/api/v2/conversations/emails/${conversationId}/participants/${participantId}/replace`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId: userId })
        });

        if (!assignResponse.ok) {
          const errorText = await assignResponse.text();
          throw new Error(`Error assigning user: ${assignResponse.status}. Details: ${errorText}`);
        }

        // Disconnect the conversation
        const disconnectResponse = await fetch(`https://api.euw2.pure.cloud/api/v2/conversations/emails/${conversationId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ state: 'disconnected' })
        });

        if (!disconnectResponse.ok) {
          console.warn('Warning: Could not disconnect conversation, but assignment was successful');
        }

        resultsDiv.innerHTML = `<div class="success-message">Success! Interaction created and assigned. Conversation ID: ${conversationId}</div>`;
        document.getElementById('externalReference').value = '';

      } catch (error) {
        resultsDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }
  </script>
</body>
</html>
