// ======= CORE API FLOW =======
async function createInteraction() {
  const queueId = document.getElementById('queueSelect').value;
  const userId  = document.getElementById('userSelect').value;
  const externalReference = (document.getElementById('externalReference').value || '').trim();

  if (!queueId || !userId) return showStatusMessage('Please select both a queue and a user', 'error');

  clearStatus();
  showLoader(true);
  setButtonDisabled(true);

  try {
    // 1) Create email interaction
    console.log('Creating email interaction...');
    const interaction = await apiFetch(`${API_BASE}/api/v2/conversations/emails`, {
      method: 'POST',
      body: JSON.stringify({
        queueId,
        provider: 'QualityForm',
        direction: 'INBOUND',
        fromName: 'External Work',
        subject: externalReference ? `External Work - ${externalReference}` : 'External Work Item',
        attributes: externalReference ? { 'External Link': externalReference } : {}
      })
    });
    const conversationId = interaction.id;
    console.log('Created interaction:', conversationId);

    // Wait for conversation to fully initialize
    await new Promise(resolve => setTimeout(resolve, 2000));

    // 2) Get conversation details to find participants
    console.log('Getting conversation details...');
    const details = await apiFetch(`${API_BASE}/api/v2/conversations/${conversationId}`);
    console.log('Participants:', details.participants);

    // 3) Find the ACD participant and assign to user
    const acdParticipant = (details.participants || []).find(p => 
      p.purpose && p.purpose.toLowerCase() === 'acd'
    );

    if (acdParticipant) {
      console.log('Found ACD participant:', acdParticipant.id);
      
      // First, let's try the direct assignment endpoint
      try {
        console.log('Trying direct assignment...');
        await apiFetch(`${API_BASE}/api/v2/conversations/${conversationId}/assign`, {
          method: 'POST',
          body: JSON.stringify({ userId })
        });
        console.log('Direct assignment successful');
      } catch (assignErr) {
        console.warn('Direct assignment failed, trying participant patch:', assignErr);
        
        // Fallback to participant patch
        await apiFetch(`${API_BASE}/api/v2/conversations/${conversationId}/participants/${acdParticipant.id}`, {
          method: 'PATCH',
          body: JSON.stringify({ 
            userId: userId,
            purpose: 'agent'
          })
        });
        console.log('Participant patch successful');
      }

      // 4) Wait longer for assignment to fully process and commit
      console.log('Waiting for assignment to commit...');
      await new Promise(resolve => setTimeout(resolve, 3000));

      // 5) Verify the assignment worked by getting updated conversation details
      console.log('Verifying assignment...');
      const updatedDetails = await apiFetch(`${API_BASE}/api/v2/conversations/${conversationId}`);
      const assignedParticipant = (updatedDetails.participants || []).find(p => 
        p.user && p.user.id === userId
      );
      
      if (assignedParticipant) {
        console.log('Assignment verified - user found in participants:', assignedParticipant.user.name);
      } else {
        console.warn('Assignment verification failed - user not found in participants');
      }

    } else {
      console.warn('No ACD participant found');
      throw new Error('Could not find participant to assign');
    }

    // 6) Disconnect the conversation
    console.log('Disconnecting conversation...');
    await apiFetch(`${API_BASE}/api/v2/conversations/emails/${conversationId}`, {
      method:'PATCH',
      body: JSON.stringify({ state: 'disconnected' })
    });
    console.log('Conversation disconnected');

    const queueName = getSelectedText('queueSelect');
    const userName  = getSelectedText('userSelect');
    showStatusMessage(
      `Interaction for <b>${escapeHTML(userName)}</b> in <b>${escapeHTML(queueName)}</b> created and stored in <b>Performance &gt; Workspace &gt; Interactions</b>.`,
      'success'
    );
  } catch (e) {
    console.error('Create interaction failed:', e);
    showStatusMessage(`Error creating interaction: ${escapeHTML(e.message)}`, 'error');
  } finally {
    showLoader(false);
    setButtonDisabled(false);
  }
}
